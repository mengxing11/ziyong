/*
new Env('ÂìÅËµûIPÁôΩÂêçÂçï');
* cron:35 0-23 * * *
by:ËêåÊ¨£
ÂìÅËµûÁôΩÂêçÂçïËá™Âä®ÊõøÊç¢Ëß£ÂÜ≥ÈùíÈæôÈù¢ÊùøÊàñÊó†ÁïåÂ§Ñ‰∫éÂÖ®Â±ÄÊ®°Âºè‰∏ãipÂú∞ÂùÄ‰∏çÊ≠£Á°Æ
ÈúÄ‰øÆÊîπ11-15Ë°å‰ª•Âèä54,55Ë°å
WxPusher‰∏ÄÂØπ‰∏ÄÔºöËÆæÁΩÆWP_APP_TOKEN_ONEÂíåWP_APP_MAIN_UIDËá™Âä®ÂêØÂä®
*/

// ÂÆö‰πâno(‰∏öÂä°ÁºñÂè∑)„ÄÅuserId(Áî®Êà∑id)„ÄÅpassword(ÁôªÂΩïÂØÜÁ†Å)„ÄÅgetkey(Â•óÈ§êÊèêÂèñÂØÜÂåô)„ÄÅsignkey(Á≠æÂêçÂØÜÂåô)
let no = '';
let userId = '';
let password = '';
let getkey = '';
let signkey = '';
if (process.env.PINZAN_NO) {
  no = process.env.PINZAN_NO;
}
if (process.env.PINZAN_USERID) {
  userId = process.env.PINZAN_USERID;
}
if (process.env.PINZAN_PASSWORD) {
  password = process.env.PINZAN_PASSWORD;
}
if (process.env.PINZAN_GETKEY) {
  getkey = process.env.PINZAN_GETKEY;
}
if (process.env.PINZAN_SIGNKEY) {
  signkey = process.env.PINZAN_SIGNKEY;
}

if (no == '') {
  console.log('ËØ∑ÂÖàÂÆö‰πâexport PINZAN_NO="‰∏öÂä°ÁºñÂè∑"');
  process.exit(0);
}
if (userId == '') {
  console.log('ËØ∑ÂÖàÂÆö‰πâexport PINZAN_USERID="Áî®Êà∑id"');
  process.exit(0);
}
if (password == '') {
  console.log('ËØ∑ÂÖàÂÆö‰πâexport PINZAN_PASSWORD="ÁôªÂΩïÂØÜÁ†Å"');
  process.exit(0);
}
if (getkey == '') {
  console.log('ËØ∑ÂÖàÂÆö‰πâexport PINZAN_GETKEY="Â•óÈ§êÊèêÂèñÂØÜÂåô"');
  process.exit(0);
}
if (signkey == '') {
  console.log('ËØ∑ÂÖàÂÆö‰πâexport PINZAN_SIGNKEY="Á≠æÂêçÂØÜÂåô"');
  process.exit(0);
}

// ‰∏ÄÂØπ‰∏ÄÈÄöÁü•
let WP_APP_TOKEN_ONE = '';
let WP_APP_MAIN_UID = '';
if (process.env.WP_APP_TOKEN_ONE) {
  WP_APP_TOKEN_ONE = process.env.WP_APP_TOKEN_ONE;
}
if (process.env.WP_APP_MAIN_UID) {
  WP_APP_MAIN_UID = process.env.WP_APP_MAIN_UID;
}

const fs = require('fs');
const request = require('request');
const notify = require('./sendNotify');
const CryptoJS = require('crypto-js')
const ipFileName = 'pinzanIp.txt';

function readSavedIp() {
  try {
    const data = fs.readFileSync(ipFileName, 'utf8');
    return data.trim();
  } catch (error) {
    return null;
  }
}

function saveIp(ip) {
  fs.writeFileSync(ipFileName, ip);
}

// Ëé∑ÂèñÂΩìÂâçIP
async function getCurrentIp(checkipurl) {
  const getIpUrl = checkipurl;
  try {
    let currentIP = await new Promise((resolve, reject) => {
      request.get(getIpUrl, (getIpError, getIpResponse, currentIP) => {
        if (getIpError) {
          reject(getIpError);
        } else {
          resolve(currentIP);
        }
      });
    });
    emojis = ['üòä', 'üòé', 'üöÄ', 'üéâ', 'üëç', 'üí°'];
    randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
    var reg = /((2(5[0-5]|[0-4]\d))|[0-1]?\d{1,2})(\.((2(5[0-5]|[0-4]\d))|[0-1]?\d{1,2})){3}/g;
    const arrcurrentIP = currentIP.match(reg);
    if (arrcurrentIP) {
      currentIP = arrcurrentIP[0];
      console.log(randomEmoji + ' ÂΩìÂâçIP:', currentIP);
      await delay(2000);
      return currentIP;
    } else {
      console.log('üí° Êú™Ëé∑ÂèñÂà∞ÂÖ¨ÁΩëIPV4Âú∞ÂùÄÔºåËøîÂõûÁ©∫‰ø°ÊÅØ„ÄÇËØ¶ÊÉÖÔºö', currentIP);
      return null;
    }
  } catch (error) {
    console.error('üí° Ëé∑ÂèñÂΩìÂâçIPÂèëÁîüÈîôËØØ:', error);
    return null;
  }
}

// Ê∑ªÂä†IPÂà∞ÁôΩÂêçÂçï
async function addIpToWhiteList(currentIP) {
  // `https://service.ipzan.com/whiteList-add?no=${no}&sign=${sign}&ip=${currentIP}`
  const data = `${password}:${getkey}:${Date.now() / 1000}`
  const key = CryptoJS.enc.Utf8.parse(signkey);
  const encryptedData = CryptoJS.AES.encrypt(data, key, {
    mode: CryptoJS.mode.ECB,
    padding: CryptoJS.pad.Pkcs7,
  });
  const sign = encryptedData.ciphertext.toString();
  const addIpUrl = `https://service.ipzan.com/whiteList-add?no=${no}&sign=${sign}&ip=${currentIP}`;
  try {
    const addIpResponse = await new Promise((resolve, reject) => {
      request.get(addIpUrl, (addIpError, addIpResponse, addIpBody) => {
        if (addIpError) {
          reject(addIpError);
        } else {
          resolve({ response: addIpResponse, body: addIpBody });
        }
      });
    });
    emojis = ['üòä', 'üòé', 'üöÄ', 'üéâ', 'üëç', 'üí°'];
    randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
    successCondition = addIpResponse.body.includes('Ê∑ªÂä†ÊàêÂäü');
    message = successCondition ? `üéâ IPÂú∞ÂùÄÂ∑≤Êõ¥Êñ∞Ôºö${currentIP}` : `üí° IPÂú∞ÂùÄÊ∑ªÂä†Â§±Ë¥•: ${addIpResponse.body}`;
    title = successCondition ? "ÂìÅËµûÁôΩÂêçÂçïÊõ¥Êç¢ÊàêÂäü ‚úÖ" : "ÂìÅËµûÁôΩÂêçÂçïÊõ¥Êç¢Â§±Ë¥• ‚ùå"; 
    console.log(randomEmoji + ' Ê∑ªÂä†IPÂà∞ÁôΩÂêçÂçïÁöÑÂìçÂ∫î:', addIpResponse.body);
    await delay(2000);
    return { success: successCondition, title, message };
  } catch (error) {
    console.error('üí° Ê∑ªÂä†IPÂà∞ÁôΩÂêçÂçïÂèëÁîüÈîôËØØ:', error);
    message = `'üí° IPÂú∞ÂùÄÊ∑ªÂä†Â§±Ë¥•:',${error}`;
    return { success: false, title: "ÂìÅËµûÁôΩÂêçÂçïÊõ¥Êç¢Â§±Ë¥• ‚ùå", message };
  }
}

// Ëé∑ÂèñÁôΩÂêçÂçïIP
async function getwhiteip() {
  //https://service.ipzan.com/whiteList-get?no=${no}&userId=${userId}
  const getIpUrl = `https://service.ipzan.com/whiteList-get?no=${no}&userId=${userId}`;
  const getIpResponse = await new Promise((resolve, reject) => {
    request.get(getIpUrl, (getIpError, getIpResponse, getIpBody) => {
      if (getIpError) {
        reject(getIpError);
      } else {
        resolve({ response: getIpResponse, body: getIpBody });
      }
    });
  });
  console.log('üí° Ëé∑ÂèñÂΩìÂâçÁôΩÂêçÂçïÁöÑÂìçÂ∫îÔºö', getIpResponse.body);
  await delay(2000);
  return getIpResponse.body;
}

// Âà†Èô§ÁôΩÂêçÂçïIP
async function delwhiteip(oldip) {
  //https://service.ipzan.com/whiteList-del?no=${no}&userId=${userId}&ip=${oldip}
  const delIpUrl = `https://service.ipzan.com/whiteList-del?no=${no}&userId=${userId}&ip=${oldip}`;
  const delIpResponse = await new Promise((resolve, reject) => {
    request.get(delIpUrl, (delIpError, delIpResponse, delIpBody) => {
      if (delIpError) {
        reject(delIpError);
      } else {
        resolve({ response: delIpResponse, body: delIpBody });
      }
    });
  });
  console.log('üí° ÁôΩÂêçÂçï‰∏≠Âà†Èô§‰∏äÊ¨°IP:', oldip, ',', delIpResponse.body);
  await delay(2000);
  return delIpResponse.body;
}

// ÂèëÈÄÅÈÄöÁü•
async function sendNotification(messageInfo) {
  console.log('')
  const { title, message } = messageInfo;
  notify.sendNotify(title, message);
}

async function main() {
  console.log('')
  let currentIP = null;
  if (!currentIP) {
    console.log('üí° ‰ΩøÁî®ip.3322Ëé∑ÂèñÂΩìÂâçIP‚Ä¶‚Ä¶');
    currentIP = await getCurrentIp('http://ip.3322.net');
    if (!currentIP) {
      console.log('üí° ‰ΩøÁî®ip.3322ËøîÂõûÂΩìÂâçIP‰∏∫Á©∫ÔºÅ');
    }
  }
  const oldip = await readSavedIp();
  if (currentIP) {
    const whiteip = await getwhiteip();
    if (oldip) {
      if (oldip.includes(currentIP) == false) {
        if (whiteip.includes(oldip) == true) {
          await delwhiteip(oldip);
        }
      }
    }
    if (whiteip.includes(currentIP) == true) {
      console.log('üòé ÂΩìÂâçIPÂú®ÁôΩÂêçÂçï‰∏≠ÔºåÁªàÊ≠¢Ê∑ªÂä†');
    } else {
      console.log('üí° ÂΩìÂâçIP‰∏çÂú®ÁôΩÂêçÂçïÂìçÂ∫î‰∏≠ÔºåÂ∞ùËØïÊ∑ªÂä†');
      resultMessage = await addIpToWhiteList(currentIP);
      await sendNotification(resultMessage);
      const wxpusherResponse = await wxpusherNotify(
        resultMessage.title,
        resultMessage.message
      );
    }
    if (oldip){
      if (oldip.includes(currentIP) == false) {
        saveIp(currentIP);
      } else {
        // console.log('Â≠òÂÇ®IP‰∏éÂΩìÂâçIP‰∏ÄËá¥');
      }
    } else {
      saveIp(currentIP);
    }
  } else {
    resultMessage = { success: false, title: "ÂìÅËµûËé∑ÂèñÂÖ¨ÁΩëIPÂ§±Ë¥• ‚ùå", message: "üí° Ëé∑ÂèñÂÖ¨ÁΩëIPËøîÂõûÁ©∫‰ø°ÊÅØÔºåÁªàÊ≠¢ÊâßË°åÔºÅ" };
    await sendNotification(resultMessage);
    const wxpusherResponse = await wxpusherNotify(
      resultMessage.title,
      resultMessage.message
    );
  }
}

main();

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function wxpusherNotify(text, desp, strsummary = "") {
    return new Promise((resolve) => {
        if (WP_APP_TOKEN_ONE && WP_APP_MAIN_UID) {
            var WPURL = "https://xip.ipzan.com/";            
            if (strsummary && strsummary.length > 96) {
                strsummary = strsummary.substring(0, 95) + "...";
            }
            let uids = [];
            for (let i of WP_APP_MAIN_UID.split(";")) {
                if (i.length != 0)
                    uids.push(i);
            };
            let topicIds = [];
            //desp = `<font size="3">${desp}</font>`;
            desp = desp.replace(/[\n\r]/g, '<br>'); // ÈªòËÆ§‰∏∫html, ‰∏çÊîØÊåÅplaintext
            desp = `<section style="width: 24rem; max-width: 100%;border:none;border-style:none;margin:2.5rem auto;" id="shifu_imi_57"
                        donone="shifuMouseDownPayStyle(&#39;shifu_imi_57&#39;)">
                        <section
                            style="margin: 0px auto;text-align: left;border: 2px solid #212122;padding: 10px 0px;box-sizing:border-box; width: 100%; display:inline-block;"
                            class="ipaiban-bc">
                            <section style="margin-top: 1rem; float: left; margin-left: 1rem; margin-left: 1rem; font-size: 1.3rem; font-weight: bold;">
                                <p style="margin: 0; color: black">
                                    ${text}
                                </p>
                            </section>
                            <section style="display: block;width: 0;height: 0;clear: both;"></section>
                            <section
                                style="margin-top:20px; display: inline-block; border-bottom: 1px solid #212122; padding: 4px 20px; box-sizing:border-box;"
                                class="ipaiban-bbc">
                                <section
                                    style="width:25px; height:25px; border-radius:50%; background-color:#212122;display:inline-block;line-height: 25px"
                                    class="ipaiban-bg">
                                    <p style="text-align:center;font-weight:1000;margin:0">
                                        <span style="color: #ffffff;font-size:20px;">üì¢</span>
                                    </p>
                                </section>
                                <section style="display:inline-block;padding-left:10px;vertical-align: top;box-sizing:border-box;">
                                </section>
                            </section>
                            <section style="margin-top:0rem;padding: 0.8rem;box-sizing:border-box;">
                                <p style=" line-height: 1.6rem; font-size: 1.1rem; ">
                                    ${desp} 
                                </p>            
                            </section>
                        </section>
                    </section>`;
            const body = {
                appToken: `${WP_APP_TOKEN_ONE}`,
                content: `${desp}`,
                summary: `${text} ${strsummary}`,
                contentType: 2,
                topicIds: topicIds,
                uids: uids,
                url: `${WPURL}`,
            };
            const options = {
                url: `http://wxpusher.zjiecode.com/api/send/message`,
                body: JSON.stringify(body),
                headers: {
                    "Content-Type": "application/json",
                },
                timeout: 15000,
            };
            request.post(options, (err, resp, data) => {
                try {
                    if (err) {
                        console.log("WxPusher ÂèëÈÄÅÈÄöÁü•Ë∞ÉÁî® API Â§±Ë¥•ÔºÅÔºÅ\n");
                        console.log(err);
                    } else {
                        data = JSON.parse(data);
                        if (data.code === 1000) {
                            console.log("WxPusher ÂèëÈÄÅÈÄöÁü•Ê∂àÊÅØÊàêÂäü!\n");
                        }
                    }
                } catch (e) {
                    $.logErr(e, resp);
                }
                finally {
                    resolve(data);
                }
            });
        } else {
            resolve();
        }
    });
}
